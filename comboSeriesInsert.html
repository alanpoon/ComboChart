<html>
<link rel="stylesheet" href="themes\base\jquery-ui.css">
<body>
<div id='v-2'></div>
<div id="sliderv-2" ></div>
<script src="d3.v3.min.js" ></script>
<script src="underscore.js" ></script>
<script src="jquery-1.7.1.js" ></script>

<script src="ui/jquery-ui.js"></script>
<script type="text/javascript"> 
var data3=[{"model":"columnStack<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":26,"category":"Apr","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":181.2,"category":"Apr","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":40,"category":"Aug","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":277.7,"category":"Aug","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":23,"category":"Dec","groupby1":"red","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":183.6,"category":"Dec","groupby1":"red","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":40,"category":"Feb","groupby1":"red","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":134.5,"category":"Feb","groupby1":"red","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":30,"category":"Jan","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":92.9,"category":"Jan","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":34,"category":"Jul","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":242,"category":"Jul","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":74,"category":"Jun","groupby1":"red","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":199,"category":"Jun","groupby1":"red","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":54,"category":"Mar","groupby1":"red","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":118.4,"category":"Mar","groupby1":"red","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":53,"category":"May","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":165,"category":"May","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":22,"category":"Nov","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":202,"category":"Nov","groupby1":"blue","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":39,"category":"Oct","groupby1":"red","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":370.1,"category":"Oct","groupby1":"red","legendKey":"Maintenance"},{"model":"<id:A>","yAxis":"L1","columnName":"sum(Diesel)","columnNameWithoutOp":"Diesel","opName":"sum","value":41,"category":"Sep","groupby1":"blue","legendKey":"Diesel"},{"model":"<id:B>","yAxis":"L1","columnName":"sum(Maintenance)","columnNameWithoutOp":"Maintenance","opName":"sum","value":360.4,"category":"Sep","groupby1":"blue","legendKey":"Maintenance"}];
var valueOperationKey="formatValueOperation";
var operation;var operationProcesser; var valueOperating;
debugFn();
var formatValueOperationCast="operation.prototype.value=function(){ return this.A-this.B;}";
//formatValueOperation is the prototype of Operation

var data7=valueOperating(data3,valueOperationKey,formatValueOperationCast);


function debugFn(){
operation=function(ABvalue){
	for (var k=0; k<_.size(Object.keys(ABvalue)); k++)
	{ var key=Object.keys(ABvalue)[k];
		this[key]=ABvalue[key]; //declare this.A and this.B as a value
	}
};
operationProcesser=function(vObj){
	//vObj={A:[...],B:[...]};
	//for each record, process operation.prototype.value once
	
	//convert key:<id:A> into just 'A'
	for(var propertyName in vObj) {
	var shortForm=propertyName.substring(propertyName.lastIndexOf("<id:")+4,propertyName.lastIndexOf(">"));
	vObj[shortForm]=vObj[propertyName];
	delete vObj[propertyName];
	}
	var ABargument=Object.keys(vObj);

	//new propertyValue 'processedValue' for vObj
	vObj['processedValue']=[];
	
	var firstABargument=ABargument[0];
	
	for (var i=0;i<_.size(vObj[firstABargument]);i++) {
		var ABvalue={};
		_.each(ABargument,function(m){
		ABvalue[m]=vObj[m][i].value;
		});
		var method=new operation(ABvalue);
		var sampleObj=_.clone(vObj[firstABargument][i]);
		console.log("sampleObj.model",JSON.stringify(sampleObj.model));
		var beforeId=(sampleObj.model).split("<id")[0];
		var afterId=(sampleObj.model).split(">")[1];
		sampleObj['value']=method.value();
		sampleObj['model']=beforeId+afterId;
		vObj['processedValue'].push(sampleObj);
	}
	console.log("sampleObj",JSON.stringify(sampleObj));
	return vObj['processedValue'];

};

valueOperating=function(modelData,valueOperationKey,formatValueOperationCast){
console.log("ui");
	if (valueOperationKey==='formatValueOperation')
	eval(formatValueOperationCast);

	var uniqModel=_.uniq(_.pluck(modelData,'model'));
	var valueOpArr=[]; //property names that contains <id:> eg. <id:A>
	var shortOpArr=[]; //eg. A
		_.each(uniqModel,function(m,n) {
		if (m.contains("<id")==true) {valueOpArr.push(m);
		var shortForm=m.substring(m.lastIndexOf("<id:")+4,m.lastIndexOf(">"));
		console.log("check shortForm",shortForm);
		shortOpArr.push(shortForm);
		}
		});
		var vObj={};
		var filterSize,inducedArr;
		_.each(valueOpArr,function(m,n){
		var filteredOp=_.where(modelData,{model:m});
		filterSize=_.size(filteredOp);
		vObj[m]=filteredOp;
		});
		
	var newVObj=operationProcesser(vObj);
	console.log("newVObj",JSON.stringify(newVObj));	
};
}


</script>
</body>
</html>